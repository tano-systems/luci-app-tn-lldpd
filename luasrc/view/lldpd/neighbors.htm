<%#
 Copyright (c) 2018, Tano Systems. All Rights Reserved.
 Anton Kikin <a.kikin@tano-systems.com>
-%>

<%+header%>

<style type="text/css">
	table.keyvalue-markup { border: 0; }
	table.keyvalue-markup td { padding: 2px 10px 2px 0; background-color: inherit !important; line-height: 16px; }
	table.keyvalue-markup td:first-of-type { vertical-align: top; font-weight: bold; white-space: nowrap; }
	table.keyvalue-markup td:last-of-type { width: 100%; }
</style>

<script type="text/javascript" src="<%=resource%>/cbi.js"></script>
<script type="text/javascript">//<![CDATA[

	function add_obj_row(description, value)
	{
		if (typeof value == 'undefined')
			return

		return '<tr><td>' + description +
			':</td><td>' + value + '</td></tr>';
	}

	function add_neighbor_row(i, obj)
	{
		var row = [];
		var inner;

		//
		// Interface
		//
		inner = '<table class="keyvalue-markup">';
		inner += add_obj_row("<%:Interface%>", obj.name);
		inner += add_obj_row("<%:Protocol%>", obj.via);
		inner += add_obj_row("<%:Age%>", obj.age);
		inner += "</table>";

		row.push(inner);

		//
		// Port
		//
		inner = '<table class="keyvalue-markup">';

		if (typeof obj.port[0].descr !== 'undefined')
			inner += add_obj_row("<%:Description%>", obj.port[0].descr[0].value);

		inner += add_obj_row("<%:ID%>", obj.port[0].id[0].value);
		inner += add_obj_row("<%:ID type%>", obj.port[0].id[0].type);
		inner += add_obj_row("<%:TTL%>", obj.port[0].ttl[0].value);
		inner += "</table>";

		row.push(inner);

		//
		// Chassis
		//
		inner = "";

		for (var chassis in obj.chassis)
		{
			var ch = obj.chassis[chassis];

			inner += '<table class="keyvalue-markup">';
			inner += add_obj_row("<%:Name%>", ch.name[0].value);
			inner += add_obj_row("<%:Description%>", ch.descr[0].value);
			inner += add_obj_row("<%:ID%>", ch.id[0].value);
			inner += add_obj_row("<%:ID type%>", ch.id[0].type);

			// Management addresses
			if (typeof ch["mgmt-ip"] !== 'undefined')
			{
				var ips = "";

				if (ch["mgmt-ip"].length > 0)
				{
					// Array of addresses
					for (var ip = 0; ip < ch["mgmt-ip"].length; ip++)
						ips += ch["mgmt-ip"][ip].value + "<br />";
				}
				else
				{
					// One address
					ips += ch["mgmt-ip"][0].value;
				}

				inner += add_obj_row("<%:Management IP(s)%>", ips);
			}

			if (typeof ch.capability !== 'undefined')
			{
				var caps = "";

				if (ch.capability.length > 0)
				{
					// Array of capabilities
					for (var cap = 0; cap < ch.capability.length; cap++)
					{
						caps += ch.capability[cap].type;
						caps += " (" + (ch.capability[cap].enabled ? "<%:enabled%>" : "<%:disabled%>") + ")";
						caps += "<br />";
					}
				}
				else
				{
					// One capability
					caps += ch.capability[0].type;
					caps += " (" + (ch.capability[0].enabled ? "<%:enabled%>" : "<%:disabled%>") + ")";
				}

				inner += add_obj_row("<%:Capabilities%>", caps);
				inner += "</td></tr>";
			}

			inner += "</table>";
		}

		row.push(inner);

		return row;
	}

	XHR.poll(5, '<%=url('admin/services/lldpd/get_neighbors')%>', null,
		function(x, json)
		{
			var nb_table =
				document.getElementById('lldpd-neighbors');

			var nb_count =
				document.getElementById('lldpd-neighbors-count');

			var rows = [];

			var ifaces = json.lldp[0].interface;

			// Fill table rows
			if (typeof ifaces !== 'undefined') {
				for (var i = 0; i < ifaces.length; i++)
					rows.push(add_neighbor_row(i, ifaces[i]));
			}

			cbi_update_table(nb_table, rows, '<em><%:No information available%></em>');

			nb_count.innerHTML = i;
		}
	)
//]]></script>

<h2 name="content"><%:LLDPd: Neighbors%> (<span id="lldpd-neighbors-count">0</span>)</h2>
<div class="cbi-map-descr"><%:This page allows you to see discovered neighbors by LLDPd%></div>

<fieldset class="cbi-section" id="cbi-table-table">
	<div class="cbi-section-node">
		<div class="table" id="lldpd-neighbors">
			<div class="tr table-titles">
				<div class="th col-1 top"><%:Local interface%></div>
				<div class="th col-1 top"><%:Discovered port%></div>
				<div class="th col-2 top"><%:Discovered chassis%></div>
			</div>
			<div class="tr placeholder">
				<div class="td">
					<em><%:Collecting data...%></em>
				</div>
			</div>
		</div>
	</div>
</fieldset>

<% include("lldpd/footer") -%>
<%+footer%>
